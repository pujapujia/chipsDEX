require("dotenv").config();
const { ethers } = require("ethers");

module.exports = async (req, res) => {
  // Koneksi ke CHIPS testnet
  const provider = new ethers.JsonRpcProvider("http://20.63.3.101:8545");
  const wallet = new ethers.Wallet(process.env.PRIVATE_KEY, provider);
  const FEE_RECEIVER = "0x00d1cBA86120485486deBef7FAE54132612b41B0";

  try {
    // ABI dan bytecode USDT
    const usdtAbi = [
      {
        "inputs": [{ "internalType": "address", "name": "_dex", "type": "address" }],
        "stateMutability": "nonpayable",
        "type": "constructor"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "spender", "type": "address" },
          { "internalType": "uint256", "name": "allowance", "type": "uint256" },
          { "internalType": "uint256", "name": "needed", "type": "uint256" }
        ],
        "name": "ERC20InsufficientAllowance",
        "type": "error"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "sender", "type": "address" },
          { "internalType": "uint256", "name": "balance", "type": "uint256" },
          { "internalType": "uint256", "name": "needed", "type": "uint256" }
        ],
        "name": "ERC20InsufficientBalance",
        "type": "error"
      },
      {
        "inputs": [{ "internalType": "address", "name": "approver", "type": "address" }],
        "name": "ERC20InvalidApprover",
        "type": "error"
      },
      {
        "inputs": [{ "internalType": "address", "name": "receiver", "type": "address" }],
        "name": "ERC20InvalidReceiver",
        "type": "error"
      },
      {
        "inputs": [{ "internalType": "address", "name": "sender", "type": "address" }],
        "name": "ERC20InvalidSender",
        "type": "error"
      },
      {
        "inputs": [{ "internalType": "address", "name": "spender", "type": "address" }],
        "name": "ERC20InvalidSpender",
        "type": "error"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "address", "name": "owner", "type": "address" },
          { "indexed": true, "internalType": "address", "name": "spender", "type": "address" },
          { "indexed": false, "internalType": "uint256", "name": "value", "type": "uint256" }
        ],
        "name": "Approval",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "address", "name": "oldDex", "type": "address" },
          { "indexed": true, "internalType": "address", "name": "newDex", "type": "address" }
        ],
        "name": "DexUpdated",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "address", "name": "from", "type": "address" },
          { "indexed": true, "internalType": "address", "name": "to", "type": "address" },
          { "indexed": false, "internalType": "uint256", "name": "value", "type": "uint256" }
        ],
        "name": "Transfer",
        "type": "event"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "owner", "type": "address" },
          { "internalType": "address", "name": "spender", "type": "address" }
        ],
        "name": "allowance",
        "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "spender", "type": "address" },
          { "internalType": "uint256", "name": "value", "type": "uint256" }
        ],
        "name": "approve",
        "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [{ "internalType": "address", "name": "account", "type": "address" }],
        "name": "balanceOf",
        "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "from", "type": "address" },
          { "internalType": "uint256", "name": "amount", "type": "uint256" }
        ],
        "name": "burn",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "decimals",
        "outputs": [{ "internalType": "uint8", "name": "", "type": "uint8" }],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "dex",
        "outputs": [{ "internalType": "address", "name": "", "type": "address" }],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "to", "type": "address" },
          { "internalType": "uint256", "name": "amount", "type": "uint256" }
        ],
        "name": "mint",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "name",
        "outputs": [{ "internalType": "string", "name": "", "type": "string" }],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [{ "internalType": "address", "name": "_newDex", "type": "address" }],
        "name": "setDex",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "symbol",
        "outputs": [{ "internalType": "string", "name": "", "type": "string" }],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "totalSupply",
        "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "to", "type": "address" },
          { "internalType": "uint256", "name": "value", "type": "uint256" }
        ],
        "name": "transfer",
        "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "from", "type": "address" },
          { "internalType": "address", "name": "to", "type": "address" },
          { "internalType": "uint256", "name": "value", "type": "uint256" }
        ],
        "name": "transferFrom",
        "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }],
        "stateMutability": "nonpayable",
        "type": "function"
      }
    ];
    const usdtBytecode = "0x60806040523480156200001157600080fd5b5060405162000cef38038062000cef833981016040819052620000349162000118565b6040518060400160405280600a81526020016915195d1a195c881554d160b21b815250604051806040016040528060048152602001631554d11560e21b8152508160039081620000859190620001ef565b506004620000948282620001ef565b5050506001600160a01b038116620000f25760405162461bcd60e51b815260206004820152601360248201527f496e76616c696420444558206164647265737300000000000000000000000000604482015260640160405180910390fd5b600580546001600160a01b0319166001600160a01b0392909216919091179055620002bb565b6000602082840312156200012b57600080fd5b81516001600160a01b03811681146200014357600080fd5b9392505050565b634e487b7160e01b600052604160045260246000fd5b600181811c908216806200017557607f821691505b6020821081036200019657634e487b7160e01b600052602260045260246000fd5b50919050565b601f821115620001ea57600081815260208120601f850160051c81016020861015620001c55750805b601f850160051c820191505b81811015620001e657828155600101620001d1565b5050505b505050565b81516001600160401b038111156200020b576200020b6200014a565b62000223816200021c845462000160565b846200019c565b602080601f8311600181146200025b5760008415620002425750858301515b600019600386901b1c1916600185901b178555620001e6565b600085815260208120601f198616915b828110156200028c578886015182559484019460019091019084016200026b565b5085821015620002ab5787850151600019600388901b60f8161c191681555b5050505050600190811b01905550565b610a2480620002cb6000396000f3fe608060405234801561001057600080fd5b50600436106100cf5760003560e01c8063447fa8b71161008c57806395d89b411161006657806395d89b41146101c55780639dc29fac146101cd578063a9059cbb146101e0578063dd62ed3e146101f357600080fd5b8063447fa8b71461015e578063692058c21461017157806370a082311461019c57600080fd5b806306fdde03146100d4578063095ea7b3146100f257806318160ddd1461011557806323b872dd14610127578063313ce5671461013a57806340c10f1914610149575b600080fd5b6100dc61022c565b6040516100e99190610843565b60405180910390f35b6101056101003660046108ad565b6102be565b60405190151581526020016100e9565b6002545b6040519081526020016100e9565b6101056101353660046108d7565b6102d8565b604051601281526020016100e9565b61015c6101573660046108ad565b6102fc565b005b61015c61016c366004610913565b610387565b600554610184906001600160a01b031681565b6040516001600160a01b0390911681526020016100e9565b6101196101aa366004610913565b6001600160a01b031660009081526020819052604090205490565b6100dc61044f565b61015c6101db3660046108ad565b61045e565b6101056101ee3660046108ad565b6104da565b610119610201366004610935565b6001600160a01b03918216600090815260016020908152604080832093909416825291909152205490565b60606003805461023b90610968565b80601f016020809104026020016040519081016040528092919081815260200182805461026790610968565b80156102b45780601f10610289576101008083540402835291602001916102b4565b820191906000526020600020905b81548152906001019060200180831161029757829003601f168201915b5050505050905090565b6000336102cc8185856104e8565b60019150505b92915050565b6000336102e68582856104fa565b6102f1858585610579565b506001949350505050565b6005546001600160a01b0316331461032f5760405162461bcd60e51b8152600401610326906109a2565b60405180910390fd5b6001600160a01b0382166103795760405162461bcd60e51b8152602060048201526011602482015270125b9d985b1a59081c9958da5c1a595b9d607a1b6044820152606401610326565b61038382826105d8565b5050565b6005546001600160a01b031633146103b15760405162461bcd60e51b8152600401610326906109a2565b6001600160a01b0381166103fd5760405162461bcd60e51b8152602060048201526013602482015272496e76616c696420444558206164647265737360681b6044820152606401610326565b600580546001600160a01b038381166001600160a01b0319831681179093556040519116919082907f7944eb377e472febf8aadfe5cfdd9fa974762abb456732d067c1e14d448d05a790600090a35050565b60606004805461023b90610968565b6005546001600160a01b031633146104885760405162461bcd60e51b8152600401610326906109a2565b6001600160a01b0382166104d05760405162461bcd60e51b815260206004820152600f60248201526e125b9d985b1a59081858d8dbdd5b9d608a1b6044820152606401610326565b610383828261060e565b6000336102cc818585610579565b6104f58383836001610644565b505050565b6001600160a01b03838116600090815260016020908152604080832093861683529290522054600019811015610573578181101561056457604051637dc7a0d960e11b81526001600160a01b03841660048201526024810182905260448101839052606401610326565b61057384848484036000610644565b50505050565b6001600160a01b0383166105a357604051634b637e8f60e11b815260006004820152602401610326565b6001600160a01b0382166105cd5760405163ec442f0560e01b815260006004820152602401610326565b6104f5838383610719565b6001600160a01b0382166106025760405163ec442f0560e01b815260006004820152602401610326565b61038360008383610719565b6001600160a01b03821661063857604051634b637e8f60e11b815260006004820152602401610326565b61038382600083610719565b6001600160a01b03841661066e5760405163e602df0560e01b815260006004820152602401610326565b6001600160a01b03831661069857604051634a1406b160e11b815260006004820152602401610326565b6001600160a01b038085166000908152600160209081526040808320938716835292905220829055801561057357826001600160a01b0316846001600160a01b03167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b9258460405161070b91815260200190565b60405180910390a350505050565b6001600160a01b03831661074457806002600082825461073991906109cd565b909155506107b69050565b6001600160a01b038316600090815260208190526040902054818110156107975760405163391434e360e21b81526001600160a01b03851660048201526024810182905260448101839052606401610326565b6001600160a01b03841660009081526020819052604090209082900390555b6001600160a01b0382166107d2576002805482900390556107f1565b6001600160a01b03821660009081526020819052604090208054820190555b816001600160a01b0316836001600160a01b03167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef8360405161083691815260200190565b60405180910390a3505050565b600060208083528351808285015260005b8181101561087057858101830151858201604001528201610854565b506000604082860101526040601f19601f8301168501019250505092915050565b80356001600160a01b03811681146108a857600080fd5b919050565b600080604083850312156108c057600080fd5b6108c983610891565b946020939093013593505050565b6000806000606084860312156108ec57600080fd5b6108f584610891565b925061090360208501610891565b9150604084013590509250925092565b60006020828403121561092557600080fd5b61092e82610891565b9392505050565b6000806040838503121561094857600080fd5b61095183610891565b915061095f60208401610891565b90509250929050565b600181811c9082168061097c57607f821691505b60208210810361099c57634e487b7160e01b600052602260045260246000fd5b50919050565b60208082526011908201527013db9b1e481111560818d85b8818d85b1b607a1b604082015260600190565b808201808211156102d257634e487b7160e01b600052601160045260246000fdfea2646970667358221220ec18de75d6fdc9afe5d4423382d2d33652e51620d0abdf6f6dfeae986f362d4f64736f6c63430008140033";

    // Deploy USDT
    const usdtFactory = new ethers.ContractFactory(usdtAbi, usdtBytecode, wallet);
    const usdtContract = await usdtFactory.deploy("0x3FB0be3029ADCecb52B0cc94825049FC2b9c0dd2"); // Alamat DEX
    await usdtContract.waitForDeployment();
    const usdtAddress = await usdtContract.getAddress();

    // ABI dan bytecode DEX
    const dexAbi = [
      {
        "inputs": [
          { "internalType": "address", "name": "_usdt", "type": "address" },
          { "internalType": "address", "name": "_feeRecipient", "type": "address" }
        ],
        "stateMutability": "nonpayable",
        "type": "constructor"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "address", "name": "funder", "type": "address" },
          { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }
        ],
        "name": "Funded",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "address", "name": "user", "type": "address" },
          { "indexed": false, "internalType": "bool", "name": "isChipsToUsdt", "type": "bool" },
          { "indexed": false, "internalType": "uint256", "name": "amountIn", "type": "uint256" },
          { "indexed": false, "internalType": "uint256", "name": "amountOut", "type": "uint256" },
          { "indexed": false, "internalType": "uint256", "name": "fee", "type": "uint256" }
        ],
        "name": "Swap",
        "type": "event"
      },
      {
        "inputs": [],
        "name": "FEE",
        "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "PRICE",
        "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "feeRecipient",
        "outputs": [{ "internalType": "address", "name": "", "type": "address" }],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "fund",
        "outputs": [],
        "stateMutability": "payable",
        "type": "function"
      },
      {
        "inputs": [{ "internalType": "uint256", "name": "usdtIn", "type": "uint256" }],
        "name": "getChipsOut",
        "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
        "stateMutability": "pure",
        "type": "function"
      },
      {
        "inputs": [{ "internalType": "uint256", "name": "chipsIn", "type": "uint256" }],
        "name": "getUsdtOut",
        "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
        "stateMutability": "pure",
        "type": "function"
      },
      {
        "inputs": [{ "internalType": "uint256", "name": "usdtAmountOut", "type": "uint256" }],
        "name": "swapChipsToUsdt",
        "outputs": [],
        "stateMutability": "payable",
        "type": "function"
      },
      {
        "inputs": [{ "internalType": "uint256", "name": "usdtAmountIn", "type": "uint256" }],
        "name": "swapUsdtToChips",
        "outputs": [],
        "stateMutability": "payable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "usdt",
        "outputs": [{ "internalType": "contract USDT", "name": "", "type": "address" }],
        "stateMutability": "view",
        "type": "function"
      },
      { "stateMutability": "payable", "type": "receive" }
    ];
    const dexBytecode = "0x608060405234801561001057600080fd5b5060405161095438038061095483398101604081905261002f9161012d565b6001600160a01b03821661008a5760405162461bcd60e51b815260206004820152601460248201527f496e76616c69642055534454206164647265737300000000000000000000000060448201526064015b60405180910390fd5b6001600160a01b0381166100e05760405162461bcd60e51b815260206004820152601560248201527f496e76616c69642066656520726563697069656e7400000000000000000000006044820152606401610081565b600080546001600160a01b039384166001600160a01b03199182161790915560018054929093169116179055610160565b80516001600160a01b038116811461012857600080fd5b919050565b6000806040838503121561014057600080fd5b61014983610111565b915061015760208401610111565b90509250929050565b6107e58061016f6000396000f3fe60806040526004361061008a5760003560e01c80638d859f3e116100595780638d859f3e14610156578063a9930f5314610172578063b60d428814610187578063c57981b51461018f578063f8a5462d146101ab57600080fd5b806313324e72146100cb5780632f48ab7d146100fe57806346904840146101365780636b4ce1df146100cb57600080fd5b366100c65760405134815233907f5af8184bef8e4b45eb9f6ed7734d04da38ced226495548f46e0c8ff8d7d9a5249060200160405180910390a2005b600080fd5b3480156100d757600080fd5b506100eb6100e63660046106f9565b6101be565b6040519081526020015b60405180910390f35b34801561010a57600080fd5b5060005461011e906001600160a01b031681565b6040516001600160a01b0390911681526020016100f5565b34801561014257600080fd5b5060015461011e906001600160a01b031681565b34801561016257600080fd5b506100eb670de0b6b3a764000081565b6101856101803660046106f9565b6101e3565b005b61018561044b565b34801561019b57600080fd5b506100eb67016345785d8a000081565b6101856101b93660046106f9565b6104a2565b6000670de0b6b3a76400006101d38382610728565b6101dd919061073f565b92915050565b6000811161020c5760405162461bcd60e51b815260040161020390610761565b60405180910390fd5b67016345785d8a00003410156102575760405162461bcd60e51b815260206004820152601060248201526f496e73756666696369656e742066656560801b6044820152606401610203565b6000670de0b6b3a764000061026c8382610728565b610276919061073f565b9050804710156102c85760405162461bcd60e51b815260206004820152601960248201527f496e73756666696369656e7420434849505320696e20444558000000000000006044820152606401610203565b6001546040516001600160a01b039091169060009067016345785d8a00009082818181858883f19350505050158015610305573d6000803e3d6000fd5b50600054604051632770a7eb60e21b8152336004820152602481018490526001600160a01b0390911690639dc29fac90604401600060405180830381600087803b15801561035257600080fd5b505af1158015610366573d6000803e3d6000fd5b50506040516000925033915083908381818185875af1925050503d80600081146103ac576040519150601f19603f3d011682016040523d82523d6000602084013e6103b1565b606091505b50509050806103f45760405162461bcd60e51b815260206004820152600f60248201526e151c985b9cd9995c8819985a5b1959608a1b6044820152606401610203565b60408051600081526020810185905290810183905267016345785d8a0000606082015233907f176648f1f11cda284c124490086be42a926ddf0ae887ebe7b1d6b337d89427569060800160405180910390a2505050565b6000341161046b5760405162461bcd60e51b815260040161020390610761565b60405134815233907f5af8184bef8e4b45eb9f6ed7734d04da38ced226495548f46e0c8ff8d7d9a5249060200160405180910390a2565b600081116104c25760405162461bcd60e51b815260040161020390610761565b6000670de0b6b3a76400006104d78184610728565b6104e1919061073f565b90506104f567016345785d8a000082610789565b3410156105395760405162461bcd60e51b8152602060048201526012602482015271496e73756666696369656e7420434849505360701b6044820152606401610203565b6001546040516001600160a01b039091169060009067016345785d8a00009082818181858883f19350505050158015610576573d6000803e3d6000fd5b506000546040516340c10f1960e01b8152336004820152602481018490526001600160a01b03909116906340c10f1990604401600060405180830381600087803b1580156105c357600080fd5b505af11580156105d7573d6000803e3d6000fd5b5050505067016345785d8a0000816105ef9190610789565b3411156106a357600067016345785d8a000061060b833461079c565b610615919061079c565b604051909150600090339083908381818185875af1925050503d806000811461065a576040519150601f19603f3d011682016040523d82523d6000602084013e61065f565b606091505b50509050806106a05760405162461bcd60e51b815260206004820152600d60248201526c1499599d5b990819985a5b1959609a1b6044820152606401610203565b50505b60408051600181526020810183905290810183905267016345785d8a0000606082015233907f176648f1f11cda284c124490086be42a926ddf0ae887ebe7b1d6b337d89427569060800160405180910390a25050565b60006020828403121561070b57600080fd5b5035919050565b634e487b7160e01b600052601160045260246000fd5b80820281158282048414176101dd576101dd610712565b60008261075c57634e487b7160e01b600052601260045260246000fd5b500490565b6020808252600e908201526d125b9d985b1a5908185b5bdd5b9d60921b604082015260600190565b808201808211156101dd576101dd610712565b818103818111156101dd576101dd61071256fea2646970667358221220c6c6c12b2dd627f2f484a4cab6b3f9e82d96fd19a64d69a09117c0c6799d1aa764736f6c63430008140033";

    // Deploy DEX dengan initial liquidity 100 CHIPS
    const dexFactory = new ethers.ContractFactory(dexAbi, dexBytecode, wallet);
    const dexContract = await dexFactory.deploy(usdtAddress, FEE_RECEIVER, { value: ethers.parseEther("100") });
    await dexContract.waitForDeployment();
    const dexAddress = await dexContract.getAddress();

    // Set DEX address di kontrak USDT
    await usdtContract.setDex(dexAddress);

    // Kirimkan informasi deployment
    res.status(200).json({
      usdtAddress,
      dexAddress,
      message: "Contracts deployed successfully!"
    });
  } catch (error) {
    console.error("Deployment failed:", error);
    res.status(500).json({ error: error.message });
  }
};
